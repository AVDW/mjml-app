<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/actions/templates.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/meriadec/mjml-desktop" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">actions</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-registerShortcuts">registerShortcuts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-exportAsGist">exportAsGist</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-comingSoon">comingSoon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-loadConfig">loadConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateConfig">updateConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-send">send</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-createNewTemplate">createNewTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-deleteTemplate">deleteTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-doUpdateTemplate">doUpdateTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-exportTemplate">exportTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-loadTemplate">loadTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-makeSnapshot">makeSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-open">open</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-readTemplates">readTemplates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-saveTemplate">saveTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-saveTemplateWithId">saveTemplateWithId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setTemplate">setTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateCurrentTemplate">updateCurrentTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-usePreset">usePreset</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">assets</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aceThemes">aceThemes</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Button.js~Button.html">Button</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/ComingSoon.js~ComingSoon.html">ComingSoon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Desktop.js~Desktop.html">Desktop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Documentation.js~Documentation.html">Documentation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/DropDown.js~DropDown.html">DropDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Editor.js~Editor.html">Editor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/EditorPage.js~EditorPage.html">EditorPage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/EditorSend.js~EditorSend.html">EditorSend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/EditorSettings.js~EditorSettings.html">EditorSettings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/FileSelector.js~FileSelector.html">FileSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Frame.js~Frame.html">Frame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/HomePage.js~HomePage.html">HomePage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Iframe.js~Iframe.html">Iframe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Mobile.js~Mobile.html">Mobile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Modal.js~Modal.html">Modal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Overlay.js~Overlay.html">Overlay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/PresetOverlayActions.js~TemplateOverlayActions.html">TemplateOverlayActions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/SideBar.js~SideBar.html">SideBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TemplateOverlayActions.js~TemplateOverlayActions.html">TemplateOverlayActions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Thumbnail.js~Thumbnail.html">Thumbnail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Tile.js~Tile.html">Tile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TileGrid.js~TileGrid.html">TileGrid</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/browse</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/browse/Presets.js~Templates.html">Templates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/browse/Templates.js~BrowseRecent.html">BrowseRecent</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">helpers</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MJMLError">MJMLError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-checkAndCreateAppFolders">checkAndCreateAppFolders</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-deleteTemplate">deleteTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-exists">exists</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-localConfig">localConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-projectFolder">projectFolder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-readFile">readFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-readTemplate">readTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-readTemplates">readTemplates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-save">save</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-thumbnailsFolder">thumbnailsFolder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-writeFile">writeFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-writeSnapshot">writeSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-error">error</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-notify">notify</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">reducers</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rootReducer">rootReducer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">store</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-configureStore">configureStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-configureStore">configureStore</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/actions/templates.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { createAction } from &apos;redux-actions&apos;
import { push } from &apos;react-router-redux&apos;
import shortid from &apos;shortid&apos;
import { Map } from &apos;immutable&apos;
import { remote } from &apos;electron&apos;
import { error, notify } from &apos;../helpers/notification&apos;
import { MJMLError } from &apos;../helpers/error&apos;

const dialog = remote.require(&apos;dialog&apos;)

import {
  readTemplates as fsReadTemplates,
  save,
  readFile,
  writeFile,
  deleteTemplate as fsDeleteTemplate,
} from &apos;../helpers/file-system&apos;

import defaultContent from &apos;../assets/defaultContent&apos;

/**
 * Triggers RECEIVE_TEMPLATES and set the templates in the store
 *
 * @param {Array} templates
 * @returns {undefined}
 */
const receiveTemplates = createAction(&apos;RECEIVE_TEMPLATES&apos;, templates =&gt; templates)

/**
 * Read all the local templates and add them to the state
 *
 * @param {Function} dispatch store.dispatch function
 * @returns {Promise}
 */
export const readTemplates = () =&gt; dispatch =&gt; {
  return fsReadTemplates()
    .then(templates =&gt; dispatch(receiveTemplates(templates)))
}

/**
 * Set the current template
 *
 * @param {Object} template the current template
 * @returns {undefined}
 */
export const setTemplate = createAction(&apos;SET_TEMPLATE&apos;, template =&gt; template)

/**
 * Set the current template and redirect the app to the editor
 *
 * @param {Object} template the new current template
 * @returns {Function} dispatch store.dispatch function
 */
export const loadTemplate = template =&gt; dispatch =&gt; {
  dispatch(setTemplate(template))
  dispatch(push(&apos;editor&apos;))
}

/**
 * Template update utilities
 */
export const doUpdateTemplate = createAction(&apos;UPDATE_TEMPLATE&apos;)
const doUpdateCurrentTemplate = createAction(&apos;UPDATE_CURRENT_TEMPLATE&apos;, updater =&gt; updater)

/**
 * Update the current template
 *
 * @param {Function} updater the update function that updates the template
 * @param {Function} dispatch store.dispatch function
 * @param {Function} getState returns the current state
 * @returns {undefined}
 */
export const updateCurrentTemplate = updater =&gt; (dispatch, getState) =&gt; {

  // create empty promise, as we don&apos;t know if we have to generate
  // html or not, #opti
  let promise = Promise.resolve()

  // get current template
  const templates = getState().templates
  const currentId = templates.get(&apos;current&apos;)
  const template = templates.get(&apos;list&apos;).find(template =&gt; template.get(&apos;id&apos;) === currentId)

  // update the template with updater
  let newTemplate = updater(template)

  // re-calculate mjml only if mjml has changed
  if (newTemplate.get(&apos;mjml&apos;) !== template.get(&apos;mjml&apos;)) {

    // get service method
    const { mjml2html } = remote.require(&apos;./services&apos;)

    // chain promise ;-) yolo
    promise = promise.then(() =&gt; new Promise(resolve =&gt; {

      // generate html
      mjml2html(newTemplate.get(&apos;mjml&apos;), (err, html) =&gt; {
        if (err) {
          newTemplate = newTemplate.set(&apos;html&apos;, MJMLError(err, template.get(&apos;html&apos;)))
        } else {
          newTemplate = newTemplate.set(&apos;html&apos;, html)
        }
        resolve()
      })

    }))

  }

  promise.then(() =&gt; {

    // update modification date
    newTemplate = newTemplate.set(&apos;modificationDate&apos;, new Date())

    // save template
    dispatch(doUpdateCurrentTemplate(() =&gt; newTemplate))

  })
}

/**
 * Finds and updates the template
 *
 * @param {String} id the wanted template&apos;s id
 * @returns {undefined}
 */
export const saveTemplateWithId = id =&gt; (dispatch, getState) =&gt; {

  const state = getState()
  const { templates, config } = state

  const list = templates.get(&apos;list&apos;)
  const template = list.get(list.findIndex(
    template =&gt; template.get(&apos;id&apos;) === id
  ))

  const cleaned = template
    .delete(&apos;thumbnailLoading&apos;)

  save(cleaned, config.get(&apos;projectDirectory&apos;))
}

/**
 * Saves the current template to the file system
 *
 * @param {Function} dispatch store.dispatch
 * @param {Function} getState returns the current state
 * @returns {undefined}
 */
export const saveTemplate = () =&gt; (dispatch, getState) =&gt; {

  const state = getState()
  const { templates } = state

  return dispatch(saveTemplateWithId(templates.get(&apos;current&apos;)))
}


const templateCreated = createAction(&apos;TEMPLATE_CREATED&apos;)

/**
 * Creates a new template
 *
 * @param {String} mjml mjml content
 * @param {Function} dispatch store.dispatch function
 * @returns {undefined}
 */
export const createNewTemplate = (mjml = defaultContent) =&gt; dispatch =&gt; {

  // get service method
  const { mjml2html } = remote.require(&apos;./services&apos;)

  mjml2html(mjml, (err, html) =&gt; {
    if (err) { return }
    const now = new Date()
    const newTemplate = Map({
      id: shortid.generate(),
      name: &apos;no name&apos;,
      mjml,
      html,
      creationDate: now,
      modificationDate: now,
    })
    dispatch(templateCreated(newTemplate))
    dispatch(setTemplate(newTemplate))
    dispatch(saveTemplate())
    dispatch(makeSnapshot(newTemplate))
    dispatch(push(&apos;editor&apos;))
  })
}


const templateDeleted = createAction(&apos;TEMPLATE_DELETED&apos;)

/**
 * Deletes a template
 *
 * @param {Object} template the template to be deleted
 * @returns {undefined}
 */
export const deleteTemplate = template =&gt; dispatch =&gt; {
  const id = template.get(&apos;id&apos;)
  dispatch(templateDeleted(id))
  fsDeleteTemplate(id)
    .then(() =&gt; notify(&apos;Deleted!&apos;))
    .catch(() =&gt; error(&apos;Not Deleted!&apos;))
}

/**
 * Show the open dialog and load an MJML template
 *
 * @param {Function} dispatch store.dispatch function
 * @returns {undefined}
 */
export const open = () =&gt; dispatch =&gt; {
  dialog.showOpenDialog({
    filters: [{ name: &apos;MJML Files&apos;, extensions: [&apos;mjml&apos;] }],
  }, (filenames) =&gt; {
    if (!filenames) { return }
    const filename = filenames[0]
    if (filename.split(&apos;.&apos;).pop() !== &apos;mjml&apos;) { return }

    readFile(filename)
      .then(content =&gt; dispatch(createNewTemplate(content)))
  })
}

/**
 * Show the save dialog to export the current template as MJML or HTML
 *
 * @param {Object} template the template to be saved
 * @param {enum(&apos;mjml&apos;, &apos;html&apos;)} type the file type
 * @returns {undefined}
 */
export const exportTemplate = ({ template, type }) =&gt; () =&gt; {
  dialog.showSaveDialog({
    defaultPath: `${template.get(&apos;name&apos;)}.${type}`,
  }, (filename) =&gt; {
    if (!filename) { return }

    const ext = filename.split(&apos;.&apos;).pop()
    const name = ext !== type ? `${filename}.${type}` : filename
    writeFile(name, template.get(type))
      .then(() =&gt; notify(&apos;Saved!&apos;))
      .catch(() =&gt; error(&apos;Not Saved!&apos;))
  })
}

/**
 * Create a snapshot of the template
 *
 * @param {Object} template
 * @param {Function} dispatch store.dispatch function
 * @returns {undefined}
 */
export const makeSnapshot = template =&gt; dispatch =&gt; {

  const id = template.get(&apos;id&apos;)
  const html = template.get(&apos;html&apos;)
  const { takeSnapshot } = remote.require(&apos;./services&apos;)

  const setLoading = template =&gt; template.set(&apos;thumbnailLoading&apos;, true)
  const stopLoading = template =&gt; template.set(&apos;thumbnailLoading&apos;, false)

  dispatch(doUpdateTemplate({ id, updater: setLoading }))

  takeSnapshot(id, html, () =&gt; {
    dispatch(doUpdateTemplate({ id, updater: stopLoading }))
  })

}

/**
 * Load a preset by creating a template with the same content as the preset.
 *
 * @param {Object} preset preset definition
 * @returns {undefined}
 */
export const usePreset = preset =&gt; dispatch =&gt; {
  dispatch(createNewTemplate(preset.get(&apos;mjml&apos;)))
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
